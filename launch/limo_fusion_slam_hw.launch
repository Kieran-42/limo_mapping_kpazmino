<?xml version="1.0"?>
<launch>
  <!-- ======= Arguments you can override at launch ======= -->
  <arg name="map_frame"         default="map"/>
  <arg name="odom_frame"        default="odom"/>
  <arg name="base_frame"        default="base_link"/>

  <!-- Default to Limo topic names; override if your hardware differs -->
  <arg name="scan_topic"        default="/limo/scan"/>
  <arg name="rgb_topic"         default="/limo/color/image_raw"/>
  <arg name="depth_topic"       default="/limo/depth/image_raw"/>
  <arg name="camera_info_topic" default="/limo/color/camera_info"/>

  <!-- true = use RTAB-Map's RGB-D odom; false = rely on wheel /odom -->
  <arg name="use_visual_odom"   default="true"/>

  <!-- where to store the persistent map database -->
  <arg name="database_path"     default="$(env HOME)/.ros/limo_fusion_map.db"/>

  <!-- ======= Real hardware uses wall clock ======= -->
  <param name="use_sim_time" value="false"/>

  <!-- ======= (Optional) Visual Odometry from RGB-D ======= -->
  <group if="$(arg use_visual_odom)">
    <node pkg="rtabmap_ros" type="rgbd_odometry" name="rgbd_odom" output="screen">
      <param name="frame_id" value="$(arg base_frame)"/>
      <param name="approx_sync" value="true"/>
      <param name="subscribe_rgbd" value="false"/>
      <remap from="rgb/image"       to="$(arg rgb_topic)"/>
      <remap from="depth/image"     to="$(arg depth_topic)"/>
      <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>
      <!-- Publishes /odom -->
    </node>
  </group>

  <!-- ======= RTAB-Map core: fuses RGB-D + LiDAR ======= -->
  <node pkg="rtabmap_ros" type="rtabmap" name="rtabmap" output="screen"
        args="--delete_db_on_start">
    <!-- Frames -->
    <param name="frame_id"     value="$(arg base_frame)"/>
    <param name="map_frame_id" value="$(arg map_frame)"/>

    <!-- Subscriptions -->
    <param name="subscribe_depth" value="true"/>
    <param name="subscribe_scan"  value="true"/>
    <remap from="scan"            to="$(arg scan_topic)"/>
    <remap from="rgb/image"       to="$(arg rgb_topic)"/>
    <remap from="depth/image"     to="$(arg depth_topic)"/>
    <remap from="rgb/camera_info" to="$(arg camera_info_topic)"/>

    <!-- Occupancy grid built from depth (plus laser for robustness) -->
    <param name="Grid/FromDepth" value="true"/>
    <param name="Grid/RangeMax"  value="6.0"/>

    <!-- Frequent updates -->
    <param name="RGBD/LinearUpdate"  value="0.05"/>
    <param name="RGBD/AngularUpdate" value="0.02"/>

    <!-- Persistence -->
    <param name="database_path" value="$(arg database_path)"/>
  </node>

  <!-- ======= Optional: publish assembled global cloud (big) ======= -->
  <node pkg="rtabmap_ros" type="point_cloud_assembler" name="cloud_assembler" output="screen">
    <remap from="cloud" to="/rtabmap/cloud_map"/>
  </node>

  <!-- ======= Optional: launch lightweight /map viewer ======= -->
  <!-- Uncomment if you installed map_viz.py in this package
  <node pkg="your_pkg" type="map_viz.py" name="map_viz" output="screen"/>
  -->
</launch>
